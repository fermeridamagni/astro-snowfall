---
/**
 * Snowfall Component - Canvas-based snowfall background animation
 *
 * @example
 * <Snowfall
 *   color="#fff"
 *   snowflakeCount={200}
 *   speed={[1, 3]}
 *   wind={[-0.5, 2]}
 *   enable3DRotation={true}
 * />
 */

import type { SnowfallCanvasConfig } from "../lib/snowfall/types";

interface Props extends SnowfallCanvasConfig {
  /**
   * CSS class name for the canvas element
   */
  class?: string;

  /**
   * CSS styles for the canvas element
   */
  style?: string;
}

const {
  color,
  radius,
  speed,
  wind,
  changeFrequency,
  rotationSpeed,
  opacity,
  enable3DRotation,
  images,
  snowflakeCount,
  showFPS,
  class: className,
  style,
} = Astro.props;

// Build config object
const config: SnowfallCanvasConfig = {
  ...(color && { color }),
  ...(radius && { radius }),
  ...(speed && { speed }),
  ...(wind && { wind }),
  ...(changeFrequency && { changeFrequency }),
  ...(rotationSpeed && { rotationSpeed }),
  ...(opacity && { opacity }),
  ...(enable3DRotation !== undefined && { enable3DRotation }),
  ...(images && { images }),
  ...(snowflakeCount && { snowflakeCount }),
  ...(showFPS !== undefined && { showFPS }),
};

// Generate unique ID for this instance
const canvasId = `snowfall-canvas-${Math.random().toString(36).substring(2, 9)}`;
---

<canvas
  id={canvasId}
  class:list={[className, "js-snowfall-canvas"]}
  style={style}
  data-config={JSON.stringify(config)}></canvas>

<script>
  import { SnowfallCanvas } from "../lib/snowfall/SnowfallCanvas";
  import type { SnowfallCanvasConfig } from "../lib/snowfall/types";

  // Store active instances to cleanup later
  const instances = new Map<string, SnowfallCanvas>();

  const initSnowfall = () => {
    const canvases = document.querySelectorAll(
      ".js-snowfall-canvas",
    ) as NodeListOf<HTMLCanvasElement>;

    canvases.forEach((canvas) => {
      // Skip if already initialized
      if (instances.has(canvas.id)) return;

      try {
        const config = JSON.parse(
          canvas.dataset.config || "{}",
        ) as SnowfallCanvasConfig;

        console.log("Initializing snowfall for:", canvas.id);

        // Set initial size
        const resizeCanvas = () => {
          const width = canvas.offsetWidth || window.innerWidth;
          const height = canvas.offsetHeight || window.innerHeight;
          canvas.width = width;
          canvas.height = height;
          return { width, height };
        };

        resizeCanvas();

        const snowfall = new SnowfallCanvas(canvas, config);
        instances.set(canvas.id, snowfall);

        // Resize observer
        const resizeObserver = new ResizeObserver(() => {
          const { width, height } = resizeCanvas();
          snowfall.resize(width, height);
        });
        resizeObserver.observe(canvas);

        // Store observer for cleanup (attach to canvas element for simplicity in this context)
        // @ts-ignore
        canvas._resizeObserver = resizeObserver;
      } catch (err) {
        console.error("Failed to initialize snowfall:", err);
      }
    });
  };

  // Cleanup function
  const cleanup = () => {
    instances.forEach((instance, id) => {
      instance.destroy();
      const canvas = document.getElementById(id);
      if (canvas) {
        // @ts-ignore
        canvas._resizeObserver?.disconnect();
      }
    });
    instances.clear();
  };

  // Initialize on load
  initSnowfall();

  // Astro View Transitions support
  document.addEventListener("astro:page-load", initSnowfall);
  document.addEventListener("astro:before-preparation", cleanup);
</script>

<style>
  canvas {
    display: block;
    width: 100%;
    height: 100%;
  }
</style>
